<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Baxnaano Hospital</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #0ea5e9; --secondary: #8b5cf6; --accent: #f97316;
            --dark: #1e293b; --light: #f8fafc; --danger: #ef4444; --success: #10b981;
            --warning: #f59e0b; --shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--light); min-height: 100vh; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .login-container { background: white; border-radius: 20px; box-shadow: var(--shadow); max-width: 400px; margin: 5rem auto; padding: 2.5rem; }
        .login-container h1 { text-align: center; margin-bottom: 2rem; color: var(--primary); }
        .error-message { padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: none; background: #fee2e2; color: var(--danger); }
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        h1 { color: var(--dark); margin-bottom: 2rem; display: flex; align-items: center; gap: 1rem; }
        .logo-img { width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--secondary)); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.8rem; }
        .card { background: white; padding: 2rem; border-radius: 15px; box-shadow: var(--shadow); margin-bottom: 2rem; }
        .card h2 { color: var(--primary); margin-bottom: 1.5rem; border-bottom: 2px solid var(--primary); padding-bottom: 0.5rem; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: bold; color: var(--dark); }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 0.8rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: var(--primary); }
        .btn { padding: 0.8rem 1.5rem; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s; }
        .btn:hover, .btn:focus { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); outline: 3px solid rgba(14, 165, 233, 0.3); }
        .btn-danger { background: var(--danger); } .btn-success { background: var(--success); } .btn-warning { background: var(--warning); }
        .btn-block { width: 100%; padding: 1rem; }
        .logout-btn { position: fixed; top: 20px; right: 20px; background: var(--danger); color: white; padding: 0.8rem 1.5rem; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; z-index: 1000; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 15px; box-shadow: var(--shadow); text-align: center; }
        .stat-card h3 { font-size: 2rem; color: var(--primary); }
        .delivery-list { display: grid; gap: 1rem; }
        .delivery-item { background: #f8fafc; padding: 1.5rem; border-radius: 10px; border-left: 5px solid var(--primary); }
        .delivery-item.PENDING { border-left-color: var(--warning); background: linear-gradient(to right, rgba(245, 158, 11, 0.05), white); }
        .delivery-item.DELIVERED { border-left-color: var(--success); background: linear-gradient(to right, rgba(16, 185, 129, 0.05), white); }
        .delivery-item.CANCELLED { border-left-color: var(--danger); background: linear-gradient(to right, rgba(239, 68, 68, 0.05), white); }
        .medicine-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-top: 1rem; }
        .medicine-card-admin { background: #f8fafc; padding: 1rem; border-radius: 10px; border: 2px solid #e2e8f0; }
        .image-preview { max-width: 150px; max-height: 150px; border-radius: 8px; margin-top: 0.5rem; display: none; }
        .loading { text-align: center; padding: 2rem; color: #64748b; }
        .error { text-align: center; padding: 2rem; color: var(--danger); }
        .notification { position: fixed; top: 20px; right: 20px; padding: 1rem 2rem; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 9999; animation: slideIn 0.5s ease; }
        .notification.success { background: var(--success); color: white; }
        .notification.error { background: var(--danger); color: white; }
        .notification.warning { background: var(--warning); color: white; }
        .hidden { display: none !important; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        footer { background: var(--dark); color: white; text-align: center; padding: 2rem; margin-top: 2rem; }

        @media (max-width: 768px) {
            .logout-btn { position: relative; top: auto; right: auto; margin-bottom: 1rem; width: 100%; }
            h1 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <!-- LOGIN FORM -->
    <div id="loginPage" class="login-container">
        <div class="logo" style="text-align: center; margin-bottom: 1.5rem; color: var(--primary); font-size: 1.8rem;" aria-hidden="true">üè•</div>
        <h2 style="text-align: center; margin-bottom: 1.5rem; color: var(--dark);">Admin Login</h2>
        <form id="loginForm">
            <div class="form-group"><label for="email">Email Address</label><input type="email" id="email" required placeholder="admin@baxnaano.com" autocomplete="username"></div>
            <div class="form-group"><label for="password">Password</label><input type="password" id="password" required placeholder="Enter password" autocomplete="current-password"></div>
            <button type="submit" class="btn btn-block" id="loginBtn">üîê Login</button>
            <div class="error-message" id="errorMsg" role="alert" aria-live="polite"></div>
        </form>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboardPage" class="hidden">
        <button class="logout-btn" id="logoutBtn" aria-label="Logout">üö™ Logout</button>
        <div class="container">
            <h1>üè• Baxnaano Hospital - Pharmacy Admin</h1>
            <div class="stats-grid">
                <div class="stat-card"><h3 id="totalOrders">0</h3><p>Total Orders</p></div>
                <div class="stat-card"><h3 id="pendingOrders">0</h3><p>Pending Delivery</p></div>
                <div class="stat-card"><h3 id="deliveredOrders">0</h3><p>Delivered</p></div>
                <div class="stat-card"><h3 id="totalRevenue">$0</h3><p>Total Revenue</p></div>
            </div>

            <div class="card"><h2>üì∏ Upload Gallery Photo</h2><form id="galleryForm">
                <div class="form-group"><label for="galleryFile">Choose Image *</label><input type="file" id="galleryFile" accept="image/*" required></div>
                <div class="form-group"><label for="galleryTitle">Title *</label><input type="text" id="galleryTitle" placeholder="e.g., Hospital Building" required></div>
                <div class="form-group"><label for="galleryDesc">Description</label><textarea id="galleryDesc" placeholder="e.g., Main entrance"></textarea></div>
                <button type="submit" class="btn btn-block" id="gallerySubmitBtn">‚ûï Add to Gallery</button>
            </form></div>

            <div class="card"><h2>üè• Manage Medicines</h2><form id="medicineForm">
                <div class="form-group"><label for="medName">Medicine Name *</label><input type="text" id="medName" placeholder="e.g., Panadol Extra" required></div>
                <div class="form-group"><label for="medPrice">Price ($) *</label><input type="number" id="medPrice" placeholder="10.99" step="0.01" required min="0"></div>
                <div class="form-group"><label for="medDesc">Description *</label><textarea id="medDesc" placeholder="Description and usage..." required></textarea></div>
                <div class="form-group"><label for="medicineImage">Medicine Image (Upload)</label><input type="file" id="medicineImage" accept="image/*"><img id="medicineImagePreview" class="image-preview" alt="Preview"></div>
                <button type="submit" class="btn btn-block" id="medicineSubmitBtn">‚ûï Add Medicine</button>
            </form><div class="medicine-grid" id="medicineList"><p class="loading">Loading medicines...</p></div></div>

            <div class="card"><h2>üöö Manage Deliveries</h2>
                <div class="form-group"><label for="deliverySearch">Search Orders (Name, Phone, or Order ID)</label><input type="text" id="deliverySearch" placeholder="üîç Search..."></div>
                <div class="form-group"><label for="deliveryFilter">Filter Status</label><select id="deliveryFilter">
                    <option value="ALL">All Orders</option><option value="PENDING">Pending</option><option value="DELIVERED">Delivered</option><option value="CANCELLED">Cancelled</option>
                </select></div>
                <button class="btn" id="exportOrdersBtn" style="margin-bottom: 1rem;">üì• Export All Orders</button>
                <div class="delivery-list" id="deliveryList"><p class="loading">Loading deliveries...</p></div>
            </div>

            <div class="card" style="border: 2px solid var(--accent);"><h2 style="color: var(--accent);">üè• Upload Hospital Logo</h2><form id="logoForm">
                <div class="form-group"><label for="logoFile">Choose Logo Image *</label><input type="file" id="logoFile" accept="image/*" required><small style="color: #64748b;">Recommended: Square image, max 2MB</small></div>
                <button type="submit" class="btn btn-block" style="background: var(--accent);" id="logoSubmitBtn">üì§ Upload Logo</button>
            </form><div id="currentLogo" style="margin-top: 1rem;"><p style="color: #64748b;">Current logo: üè• (default)</p></div></div>

            <div class="card" style="background: linear-gradient(135deg, #fef3c7, #fff); border: 2px solid var(--warning);">
                <h2 style="color: var(--warning);">‚ö†Ô∏è Data Backup & Restore</h2>
                <p style="margin-bottom: 1rem;"><strong>Export all data</strong> for backup:</p>
                <button class="btn-warning btn-block" id="exportAllBtn">üì§ Export All Data</button>
                <p style="margin: 2rem 0 1rem;"><strong>Import data</strong> from backup:</p>
                <input type="file" id="importFile" accept=".json" class="hidden">
                <button class="btn-warning" id="importBtn">üì• Import Data</button>
                <p style="margin-top: 1rem; font-size: 0.9rem; color: #666;">‚ö†Ô∏è Importing will overwrite existing data. Use with caution.</p>
            </div>
        </div>
    </div>

    <!-- ===== üîë FIREBASE CONFIG SECTION - KU DARI HAGAAGKAAGA Halkan ===== -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // TODO: KU DARI HAGAAGKAAGA FIIREBASE KA Halkan
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY_HERE",           // <--- BADAL
            authDomain: "YOUR_PROJECT.firebaseapp.com", // <--- BADAL
            projectId: "YOUR_PROJECT_ID",         // <--- BADAL
            storageBucket: "YOUR_PROJECT.appspot.com", // <--- BADAL
            messagingSenderId: "YOUR_SENDER_ID", // <--- BADAL
            appId: "YOUR_APP_ID"                   // <--- BADAL
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const auth = getAuth(app);

        window.DataManager = {
            medicines: collection(db, 'medicines'),
            orders: collection(db, 'orders'),
            gallery: collection(db, 'gallery'),
            settings: collection(db, 'settings'),
            
            async getMedicines() {
                const snapshot = await getDocs(this.medicines);
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            },
            
            async saveMedicine(medicine) {
                return await addDoc(this.medicines, { ...medicine, createdAt: new Date().toISOString() });
            },
            
            async updateMedicine(id, medicine) {
                return await updateDoc(doc(db, 'medicines', id), medicine);
            },
            
            async deleteMedicine(id) {
                return await deleteDoc(doc(db, 'medicines', id));
            },
            
            async getOrders() {
                const q = query(this.orders, orderBy('timestamp', 'desc'));
                const snapshot = await getDocs(q);
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            },
            
            async updateOrder(id, status) {
                return await updateDoc(doc(db, 'orders', id), { status });
            },
            
            async deleteOrder(id) {
                return await deleteDoc(doc(db, 'orders', id));
            },
            
            async getGallery() {
                const snapshot = await getDocs(this.gallery);
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            },
            
            async saveGalleryItem(item) {
                return await addDoc(this.gallery, { ...item, date: new Date().toISOString().split('T')[0] });
            },
            
            async getSettings() {
                const snapshot = await getDocs(this.settings);
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            },
            
            async saveSetting(key, value) {
                const settings = await this.getSettings();
                const existing = settings.find(s => s.key === key);
                if (existing) {
                    return await updateDoc(doc(db, 'settings', existing.id), { value, updatedAt: new Date().toISOString() });
                } else {
                    return await addDoc(this.settings, { key, value, createdAt: new Date() });
                }
            }
        };

        onSnapshot(collection(db, 'medicines'), () => window.adminApp?.loadMedicines());
        onSnapshot(query(collection(db, 'orders'), orderBy('timestamp', 'desc')), () => {
            window.adminApp?.loadDeliveries();
            window.adminApp?.updateStats();
        });
        onSnapshot(collection(db, 'gallery'), () => window.adminApp?.loadGallery());
        onSnapshot(collection(db, 'settings'), () => window.adminApp?.loadSettings());

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Check if user is admin
                const adminRef = doc(db, 'admins', user.uid);
                getDocs(collection(db, 'admins')).then(snapshot => {
                    const isAdmin = snapshot.docs.some(doc => doc.id === user.uid);
                    if (isAdmin) {
                        window.adminApp.showDashboard();
                    } else {
                        window.adminApp.showError('‚ùå Admin access required');
                        signOut(auth);
                    }
                });
            } else {
                document.getElementById('loginPage').classList.remove('hidden');
                document.getElementById('dashboardPage').classList.add('hidden');
            }
        });
    </script>

    <script>
        class AdminApp {
            constructor() {
                this.editingMedicineId = null;
                this.auth = window.auth;
                this.initEventListeners();
            }

            initEventListeners() {
                document.getElementById('loginForm')?.addEventListener('submit', (e) => this.login(e));
                document.getElementById('logoutBtn')?.addEventListener('click', () => this.logout());
                document.getElementById('medicineForm')?.addEventListener('submit', (e) => this.handleMedicineSubmit(e));
                document.getElementById('medicineImage')?.addEventListener('change', (e) => this.previewMedicineImage(e));
                document.getElementById('galleryForm')?.addEventListener('submit', (e) => this.handleGallerySubmit(e));
                document.getElementById('logoForm')?.addEventListener('submit', (e) => this.handleLogoSubmit(e));
                document.getElementById('deliverySearch')?.addEventListener('input', (e) => this.searchDeliveries(e.target.value));
                document.getElementById('deliveryFilter')?.addEventListener('change', () => this.filterDeliveries());
                document.getElementById('exportOrdersBtn')?.addEventListener('click', () => this.exportOrders());
                document.getElementById('exportAllBtn')?.addEventListener('click', () => this.exportAllData());
                document.getElementById('importBtn')?.addEventListener('click', () => document.getElementById('importFile').click());
                document.getElementById('importFile')?.addEventListener('change', (e) => this.importAllData(e));
            }

            async login(event) {
                event.preventDefault();
                const loginBtn = document.getElementById('loginBtn');
                const errorMsg = document.getElementById('errorMsg');
                loginBtn.disabled = true;
                loginBtn.textContent = '‚è≥ Logging in...';
                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password').value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    errorMsg.style.display = 'none';
                } catch (error) {
                    errorMsg.textContent = `‚ùå ${error.message}`;
                    errorMsg.style.display = 'block';
                    setTimeout(() => errorMsg.style.display = 'none', 5000);
                } finally {
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'üîê Login';
                }
            }

            logout() {
                if (confirm('üö™ Are you sure you want to logout?')) {
                    signOut(auth);
                }
            }

            showDashboard() {
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('dashboardPage').classList.remove('hidden');
                this.loadMedicines();
                this.loadDeliveries();
                this.loadSettings();
            }

            showError(message) {
                const errorMsg = document.getElementById('errorMsg');
                errorMsg.textContent = message;
                errorMsg.style.display = 'block';
                setTimeout(() => errorMsg.style.display = 'none', 5000);
            }

            async loadMedicines() {
                const list = document.getElementById('medicineList');
                try {
                    const medicines = await DataManager.getMedicines();
                    if (medicines.length === 0) {
                        list.innerHTML = '<p class="error">No medicines found. Add some to get started.</p>';
                        return;
                    }
                    list.innerHTML = medicines.map(med => `
                        <div class="medicine-card-admin">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <strong>${this.escapeHtml(med.name)}</strong>
                                <span style="color: var(--primary); font-weight: bold;">$${Number(med.price).toFixed(2)}</span>
                            </div>
                            <p style="color: #64748b; margin: 0.5rem 0;">${this.escapeHtml(med.description)}</p>
                            <div style="margin: 0.5rem 0;">
                                ${med.image ? `<img src="${med.image}" style="max-width: 100px; border-radius: 8px;" alt="${this.escapeHtml(med.name)}">` : '<span style="font-size: 2rem;">üíä</span>'}
                            </div>
                            <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                                <button class="btn" data-edit="${med.id}" style="flex: 1; font-size: 0.9rem; padding: 0.5rem;">‚úèÔ∏è Edit</button>
                                <button class="btn-danger" data-delete="${med.id}" style="flex: 1; font-size: 0.9rem; padding: 0.5rem;">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                    `).join('');
                    list.querySelectorAll('[data-edit]').forEach(btn => {
                        btn.addEventListener('click', () => this.editMedicine(btn.dataset.edit));
                    });
                    list.querySelectorAll('[data-delete]').forEach(btn => {
                        btn.addEventListener('click', () => this.deleteMedicine(btn.dataset.delete));
                    });
                } catch (error) {
                    list.innerHTML = `<p class="error">Failed to load medicines: ${error.message}</p>`;
                }
            }

            handleMedicineSubmit(event) {
                event.preventDefault();
                if (this.editingMedicineId) {
                    this.updateMedicine();
                } else {
                    this.addMedicine();
                }
            }

            async addMedicine() {
                const submitBtn = document.getElementById('medicineSubmitBtn');
                submitBtn.disabled = true;
                submitBtn.textContent = '‚è≥ Adding...';
                const name = document.getElementById('medName').value.trim();
                const price = parseFloat(document.getElementById('medPrice').value);
                const description = document.getElementById('medDesc').value.trim();
                try {
                    if (!name || isNaN(price) || !description) {
                        throw new Error('Please fill all required fields');
                    }
                    const imageFile = document.getElementById('medicineImage').files[0];
                    let imageUrl = null;
                    if (imageFile) {
                        if (imageFile.size > 5 * 1024 * 1024) {
                            throw new Error('Image too large! Max 5MB');
                        }
                        imageUrl = await this.uploadFile(imageFile, 'medicines');
                    }
                    await DataManager.saveMedicine({ name, price, description, image: imageUrl });
                    this.showNotification('‚úÖ Medicine added successfully', 'success');
                    this.clearMedicineForm();
                } catch (error) {
                    this.showError(`‚ùå ${error.message}`);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = '‚ûï Add Medicine';
                }
            }

            async editMedicine(id) {
                try {
                    const medicines = await DataManager.getMedicines();
                    const med = medicines.find(m => m.id === id);
                    if (med) {
                        document.getElementById('medName').value = med.name;
                        document.getElementById('medPrice').value = med.price;
                        document.getElementById('medDesc').value = med.description;
                        if (med.image) {
                            const img = document.getElementById('medicineImagePreview');
                            img.src = med.image;
                            img.style.display = 'block';
                        }
                        this.editingMedicineId = id;
                        document.getElementById('medicineSubmitBtn').textContent = 'üíæ Update Medicine';
                        document.querySelector('.card h2').scrollIntoView({ behavior: 'smooth' });
                    }
                } catch (error) {
                    this.showError(`‚ùå Failed to load medicine: ${error.message}`);
                }
            }

            async updateMedicine() {
                if (!this.editingMedicineId) return;
                const submitBtn = document.getElementById('medicineSubmitBtn');
                submitBtn.disabled = true;
                submitBtn.textContent = '‚è≥ Updating...';
                const name = document.getElementById('medName').value.trim();
                const price = parseFloat(document.getElementById('medPrice').value);
                const description = document.getElementById('medDesc').value.trim();
                try {
                    const imageFile = document.getElementById('medicineImage').files[0];
                    let imageUrl = null;
                    if (imageFile) {
                        if (imageFile.size > 5 * 1024 * 1024) {
                            throw new Error('Image too large! Max 5MB');
                        }
                        imageUrl = await this.uploadFile(imageFile, 'medicines');
                    }
                    const updateData = { name, price, description };
                    if (imageUrl) updateData.image = imageUrl;
                    await DataManager.updateMedicine(this.editingMedicineId, updateData);
                    this.showNotification('‚úÖ Medicine updated successfully', 'success');
                    this.clearMedicineForm();
                    document.getElementById('medicineSubmitBtn').textContent = '‚ûï Add Medicine';
                    this.editingMedicineId = null;
                } catch (error) {
                    this.showError(`‚ùå ${error.message}`);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = '‚ûï Add Medicine';
                }
            }

            async deleteMedicine(id) {
                if (confirm('üóëÔ∏è Delete this medicine? This cannot be undone.')) {
                    try {
                        await DataManager.deleteMedicine(id);
                        this.showNotification('‚úÖ Medicine deleted successfully', 'success');
                    } catch (error) {
                        this.showError(`‚ùå ${error.message}`);
                    }
                }
            }

            previewMedicineImage(event) {
                const file = event.target.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) {
                        this.showError('‚ùå File too large! Maximum size is 5MB');
                        event.target.value = '';
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = document.getElementById('medicineImagePreview');
                        img.src = e.target.result;
                        img.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            }

            clearMedicineForm() {
                document.getElementById('medicineForm').reset();
                document.getElementById('medicineImagePreview').style.display = 'none';
            }

            async handleGallerySubmit(event) {
                event.preventDefault();
                const submitBtn = document.getElementById('gallerySubmitBtn');
                submitBtn.disabled = true;
                submitBtn.textContent = '‚è≥ Uploading...';
                const file = document.getElementById('galleryFile').files[0];
                const title = document.getElementById('galleryTitle').value.trim();
                const desc = document.getElementById('galleryDesc').value.trim();
                try {
                    if (!file || !title) {
                        throw new Error('Please select an image and enter a title');
                    }
                    if (file.size > 5 * 1024 * 1024) {
                        throw new Error('File too large! Maximum size is 5MB');
                    }
                    const imageUrl = await this.uploadFile(file, 'gallery');
                    await DataManager.saveGalleryItem({ type: 'image', url: imageUrl, title, description: desc });
                    this.showNotification('‚úÖ Gallery photo uploaded successfully', 'success');
                    document.getElementById('galleryForm').reset();
                } catch (error) {
                    this.showError(`‚ùå ${error.message}`);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = '‚ûï Add to Gallery';
                }
            }

            async loadSettings() {
                try {
                    const settings = await DataManager.getSettings();
                    const logoSetting = settings.find(s => s.key === 'logo');
                    if (logoSetting?.value) {
                        document.getElementById('currentLogo').innerHTML = `<img src="${logoSetting.value}" style="max-width: 100px; border-radius: 50%;" alt="Current Logo">`;
                    }
                } catch (error) {
                    console.error("Failed to load logo:", error);
                }
            }

            async handleLogoSubmit(event) {
                event.preventDefault();
                const submitBtn = document.getElementById('logoSubmitBtn');
                submitBtn.disabled = true;
                submitBtn.textContent = '‚è≥ Uploading...';
                const file = document.getElementById('logoFile').files[0];
                try {
                    if (!file) {
                        throw new Error('Please select a logo image');
                    }
                    if (file.size > 2 * 1024 * 1024) {
                        throw new Error('Logo too large! Max 2MB');
                    }
                    const logoUrl = await this.uploadFile(file, 'logos');
                    await DataManager.saveSetting('logo', logoUrl);
                    this.showNotification('‚úÖ Logo uploaded successfully', 'success');
                    document.getElementById('logoForm').reset();
                    this.loadSettings();
                } catch (error) {
                    this.showError(`‚ùå ${error.message}`);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'üì§ Upload Logo';
                }
            }

            async uploadFile(file, folder) {
                try {
                    const storageRef = ref(storage, `${folder}/${Date.now()}_${file.name}`);
                    await uploadBytes(storageRef, file);
                    return await getDownloadURL(storageRef);
                } catch (error) {
                    throw new Error(`Upload failed: ${error.message}`);
                }
            }

            async loadDeliveries() {
                const list = document.getElementById('deliveryList');
                try {
                    this.allDeliveries = await DataManager.getOrders();
                    if (this.allDeliveries.length === 0) {
                        list.innerHTML = '<p class="error">No delivery orders found.</p>';
                        return;
                    }
                    this.renderDeliveries(this.allDeliveries);
                    this.updateStats();
                } catch (error) {
                    list.innerHTML = `<p class="error">Failed to load deliveries: ${error.message}</p>`;
                }
            }

            renderDeliveries(deliveries) {
                const list = document.getElementById('deliveryList');
                const filter = document.getElementById('deliveryFilter').value;
                const filtered = filter === 'ALL' ? deliveries : deliveries.filter(d => d.status === filter);
                if (filtered.length === 0) {
                    list.innerHTML = '<p class="error">No orders match your filter.</p>';
                    return;
                }
                list.innerHTML = filtered.map(delivery => `
                    <div class="delivery-item ${delivery.status}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <strong>Order #${delivery.id.substring(0, 8)}</strong>
                            <span style="background: ${delivery.status === 'PENDING' ? '#f59e0b' : delivery.status === 'DELIVERED' ? '#10b981' : '#ef4444'}; color: white; padding: 0.3rem 1rem; border-radius: 20px; font-size: 0.85rem;">${delivery.status}</span>
                        </div>
                        <p><strong>Customer:</strong> ${this.escapeHtml(delivery.customerName)}</p>
                        <p><strong>Phone:</strong> <a href="tel:${delivery.customerPhone}" style="color: var(--primary);">${delivery.customerPhone}</a></p>
                        <p><strong>Address:</strong> ${this.escapeHtml(delivery.deliveryAddress)}</p>
                        <p><strong>Total:</strong> $${Number(delivery.totalAmount).toFixed(2)}</p>
                        <p><strong>Time:</strong> ${new Date(delivery.timestamp).toLocaleString()}</p>
                        <div style="margin: 1rem 0;"><strong>Medicines:</strong><ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                            ${delivery.medicines.map(m => `<li>${this.escapeHtml(m.name)} (${m.quantity || 1}) - $${Number(m.price).toFixed(2)}</li>`).join('')}
                        </ul></div>
                        ${delivery.instructions ? `<p><strong>Instructions:</strong> ${this.escapeHtml(delivery.instructions)}</p>` : ''}
                        ${delivery.prescription ? `<p><strong>Prescription:</strong><br><img src="${delivery.prescription}" style="max-width: 150px; border-radius: 8px;" alt="Prescription"></p>` : ''}
                        <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            ${delivery.status === 'PENDING' 
                                ? `<button class="btn-success" data-mark-delivered="${delivery.id}" style="flex: 1; min-width: 150px;">‚úÖ Mark Delivered</button>
                                   <button class="btn-danger" data-cancel="${delivery.id}" style="flex: 1; min-width: 150px;">‚ùå Cancel</button>` 
                                : ''
                            }
                            <button class="btn" data-view="${delivery.id}" style="flex: 1; min-width: 150px;">üëÅÔ∏è View Details</button>
                            <button class="btn-danger" data-delete="${delivery.id}" style="flex: 1; min-width: 150px;">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `).join('');
                list.querySelectorAll('[data-mark-delivered]').forEach(btn => {
                    btn.addEventListener('click', () => this.updateDeliveryStatus(btn.dataset.markDelivered, 'DELIVERED'));
                });
                list.querySelectorAll('[data-cancel]').forEach(btn => {
                    btn.addEventListener('click', () => this.updateDeliveryStatus(btn.dataset.cancel, 'CANCELLED'));
                });
                list.querySelectorAll('[data-view]').forEach(btn => {
                    btn.addEventListener('click', () => this.viewDeliveryDetails(btn.dataset.view));
                });
                list.querySelectorAll('[data-delete]').forEach(btn => {
                    btn.addEventListener('click', () => this.deleteDelivery(btn.dataset.delete));
                });
            }

            searchDeliveries(query) {
                if (!query.trim()) {
                    this.renderDeliveries(this.allDeliveries);
                    return;
                }
                const filtered = this.allDeliveries.filter(d => 
                    d.customerName.toLowerCase().includes(query.toLowerCase()) ||
                    d.customerPhone.includes(query) ||
                    d.id.toLowerCase().includes(query.toLowerCase())
                );
                this.renderDeliveries(filtered);
            }

            filterDeliveries() {
                this.renderDeliveries(this.allDeliveries);
            }

            async updateDeliveryStatus(id, newStatus) {
                try {
                    await DataManager.updateOrder(id, newStatus);
                    this.showNotification(`‚úÖ Order marked as ${newStatus}`, 'success');
                } catch (error) {
                    this.showError(`‚ùå ${error.message}`);
                }
            }

            viewDeliveryDetails(id) {
                const delivery = this.allDeliveries.find(d => d.id === id);
                if (delivery) {
                    const details = `
Order ID: ${delivery.id}
Customer: ${this.escapeHtml(delivery.customerName)}
Phone: ${delivery.customerPhone}
Address: ${this.escapeHtml(delivery.deliveryAddress)}
Total: $${Number(delivery.totalAmount).toFixed(2)}
Status: ${delivery.status}
Date: ${new Date(delivery.timestamp).toLocaleString()}

Medicines:
${delivery.medicines.map(m => `- ${this.escapeHtml(m.name)} (${m.quantity || 1}) - $${Number(m.price).toFixed(2)}`).join('\n')}

${delivery.instructions ? `Instructions: ${this.escapeHtml(delivery.instructions)}` : ''}
                    `;
                    alert(details);
                }
            }

            async deleteDelivery(id) {
                if (confirm(`üóëÔ∏è Delete order ${id.substring(0, 8)}? This cannot be undone.`)) {
                    try {
                        await DataManager.deleteOrder(id);
                        this.showNotification('‚úÖ Order deleted successfully', 'success');
                    } catch (error) {
                        this.showError(`‚ùå ${error.message}`);
                    }
                }
            }

            exportOrders() {
                if (this.allDeliveries.length === 0) {
                    this.showError('‚ùå No orders to export');
                    return;
                }
                const csv = [
                    ['Order ID', 'Customer', 'Phone', 'Address', 'Total', 'Status', 'Date', 'Medicines'],
                    ...this.allDeliveries.map(d => [
                        d.id, 
                        `"${this.escapeHtml(d.customerName).replace(/"/g, '""')}"`, 
                        d.customerPhone, 
                        `"${this.escapeHtml(d.deliveryAddress).replace(/"/g, '""')}"`, 
                        Number(d.totalAmount).toFixed(2), 
                        d.status, 
                        new Date(d.timestamp).toLocaleString(),
                        `"${d.medicines.map(m => `${this.escapeHtml(m.name)} (${m.quantity || 1})`).join(', ')}"`
                    ])
                ].map(row => row.join(',')).join('\n');
                this.downloadFile(csv, `baxnaano-orders-${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
                this.showNotification('‚úÖ Orders exported successfully', 'success');
            }

            updateStats() {
                const total = this.allDeliveries.length;
                const pending = this.allDeliveries.filter(d => d.status === 'PENDING').length;
                const delivered = this.allDeliveries.filter(d => d.status === 'DELIVERED').length;
                const revenue = this.allDeliveries
                    .filter(d => d.status !== 'CANCELLED')
                    .reduce((sum, d) => sum + Number(d.totalAmount), 0);
                document.getElementById('totalOrders').textContent = total;
                document.getElementById('pendingOrders').textContent = pending;
                document.getElementById('deliveredOrders').textContent = delivered;
                document.getElementById('totalRevenue').textContent = `$${revenue.toFixed(2)}`;
            }

            async exportAllData() {
                try {
                    const data = {
                        medicines: await DataManager.getMedicines(),
                        orders: await DataManager.getOrders(),
                        gallery: await DataManager.getGallery(),
                        settings: await DataManager.getSettings(),
                        exportDate: new Date().toISOString(),
                        version: '1.0'
                    };
                    const json = JSON.stringify(data, null, 2);
                    this.downloadFile(json, `baxnaano-backup-${new Date().toISOString().split('T')[0]}.json`, 'application/json');
                    this.showNotification('‚úÖ Full backup exported successfully', 'success');
                } catch (error) {
                    this.showError(`‚ùå ${error.message}`);
                }
            }

            async importAllData(event) {
                const file = event.target.files[0];
                if (!file) return;
                if (!confirm('‚ö†Ô∏è WARNING: This will overwrite all existing data. Are you absolutely sure?')) {
                    event.target.value = '';
                    return;
                }
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    if (!data.medicines || !data.orders || !data.gallery || !data.settings) {
                        throw new Error('Invalid backup file structure');
                    }
                    this.showNotification('‚ö†Ô∏è Import feature requires manual implementation for safety', 'warning');
                    event.target.value = '';
                } catch (error) {
                    this.showError(`‚ùå ${error.message}`);
                    event.target.value = '';
                }
            }

            downloadFile(content, filename, type) {
                const blob = new Blob([content], { type });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.setAttribute('role', 'alert');
                notification.setAttribute('aria-live', 'polite');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                document.body.appendChild(notification);
                setTimeout(() => {
                    notification.style.animation = 'fadeOut 0.5s ease';
                    setTimeout(() => notification.remove(), 500);
                }, 5000);
            }

            async init() {
                if (document.getElementById('dashboardPage').classList.contains('hidden') === false) {
                    await this.loadMedicines();
                    await this.loadDeliveries();
                    await this.loadSettings();
                    this.updateStats();
                }
            }
        }

        window.adminApp = new AdminApp();
        window.addEventListener('DOMContentLoaded', () => window.adminApp.init());
    </script>
</body>
</html>
